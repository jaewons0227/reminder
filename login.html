<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ÏñºÍµ¥ Î°úÍ∑∏Ïù∏</title>

<script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
body {
  margin: 0;
  background: radial-gradient(circle at top, #0f172a, #020617);
  color: white;
  font-family: Arial;
  text-align: center;
}

h1 {
  margin-top: 40px;
}

.container {
  margin-top: 30px;
}

video {
  width: 340px;
  border-radius: 20px;
  border: 3px solid #38bdf8;
}

.progress-wrap {
  width: 60%;
  height: 10px;
  background: #1e293b;
  margin: 25px auto;
  border-radius: 8px;
}

.progress {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg,#22d3ee,#38bdf8);
  border-radius: 8px;
  transition: .3s;
}

.status {
  color: #38bdf8;
  margin-top: 15px;
}

.result {
  font-size: 20px;
  margin-top: 20px;
}
</style>
</head>

<body>

<h1>ÏñºÍµ¥ Î°úÍ∑∏Ïù∏</h1>

<div class="container">

  <video id="video" autoplay muted></video>

  <div class="status" id="status">Î™®Îç∏ Î°úÎî©Ï§ë...</div>

  <div class="progress-wrap">
    <div class="progress" id="progress"></div>
  </div>

  <div id="counter">0 / 10 ÏàòÏßë</div>

  <div class="result" id="result"></div>

</div>

<script>
const video = document.getElementById("video");
const statusText = document.getElementById("status");
const counter = document.getElementById("counter");
const progress = document.getElementById("progress");
const resultBox = document.getElementById("result");

const REQUIRED = 10;
let collected = [];
let detecting = true;

// -------------------------

async function loadModels() {
  await Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri("./models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("./models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("./models")
  ]);

  statusText.innerText = "Ïπ¥Î©îÎùº ÏãúÏûëÏ§ë...";
  startCamera();
}

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;

  statusText.innerText = "Ï†ïÎ©¥ÏùÑ Î¥êÏ£ºÏÑ∏Ïöî";
  startDetectLoop();
}

// -------------------------

async function startDetectLoop() {

  const interval = setInterval(async () => {

    if (!detecting || collected.length >= REQUIRED) return;

    const detection = await faceapi
      .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({
        inputSize: 224,
        scoreThreshold: 0.4   // üî• ÎÇÆÏ∂∞ÏÑú Ïù∏Ïãù Ïûò ÎêòÍ≤å
      }))
      .withFaceLandmarks()
      .withFaceDescriptor();

    if (!detection) return;

    collected.push(detection.descriptor);

    counter.innerText = `${collected.length} / ${REQUIRED} ÏàòÏßë`;
    progress.style.width = `${(collected.length / REQUIRED) * 100}%`;

    if (collected.length >= REQUIRED) {
      clearInterval(interval);
      detecting = false;
      statusText.innerText = "Î∂ÑÏÑùÏ§ë...";
      sendLogin();
    }

  }, 800);
}

// -------------------------

function averageVectors(vectors) {

  const avg = new Array(vectors[0].length).fill(0);

  vectors.forEach(v => {
    v.forEach((val, i) => avg[i] += val);
  });

  return avg.map(v => v / vectors.length);
}

// -------------------------

async function sendLogin() {

  const avgVector = averageVectors(collected);

  const res = await fetch("https://jaewondev2.pythonanywhere.com/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      vector: avgVector
    })
  });

  const data = await res.json();

  if (data.success) {

    const percent = Math.max(0, Math.round((1 - data.distance) * 100));

    resultBox.innerHTML =
      `‚úÖ Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ<br>${data.name}<br>${percent}% ÏùºÏπò`;

  } else {

    const percent = Math.max(0, Math.round((1 - data.distance) * 100));

    resultBox.innerHTML =
      `‚ùå Ïã§Ìå®<br>${percent}% ÏùºÏπò`;

  }

}
loadModels();
</script>

</body>
</html>
