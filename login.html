<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>얼굴 로그인</title>

<script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
body {
  margin: 0;
  background-color: #ffffff;
  color: #191f28;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}

h1 {
  margin-top: 60px;
  font-size: 26px;
  font-weight: 700;
  color: #333d4b;
}

.container {
  margin-top: 40px;
  position: relative;
  width: 320px;
  height: 320px;
  display: flex;
  justify-content: center;
  align-items: center;
}

video {
  width: 280px;
  height: 280px;
  border-radius: 50%;
  object-fit: cover;
  background-color: #f2f4f6;
  transform: scaleX(-1);
  position: absolute;
  z-index: 1;
}

.progress-ring {
  position: absolute;
  top: 0;
  left: 0;
  width: 320px;
  height: 320px;
  transform: rotate(-90deg);
  z-index: 2;
  pointer-events: none;
}

.progress-ring__circle-bg {
  stroke: #e5e8eb;
  stroke-width: 8;
  fill: transparent;
}

.progress-ring__circle {
  stroke: #3182f6;
  stroke-width: 8;
  fill: transparent;
  stroke-linecap: round;
  stroke-dasharray: 942;
  stroke-dashoffset: 942;
  transition: stroke-dashoffset 0.5s ease-in-out, stroke 0.5s ease-in-out;
}

/* 구글 스타일 스피너 */
.loading-overlay {
  position: absolute;
  z-index: 10;
  background: rgba(255,255,255,0.7);
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 50%;
}

.google-spinner {
  display: inline-block;
  width: 50px;
  height: 50px;
  position: relative;
}

.google-spinner div {
  box-sizing: border-box;
  display: block;
  position: absolute;
  width: 50px;
  height: 50px;
  margin: 0;
  border: 5px solid #3182f6;
  border-radius: 50%;
  animation: google-spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
  border-color: #3182f6 transparent transparent transparent;
}

.google-spinner div:nth-child(1) { animation-delay: -0.45s; }
.google-spinner div:nth-child(2) { animation-delay: -0.3s; }
.google-spinner div:nth-child(3) { animation-delay: -0.15s; }

@keyframes google-spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 성공 모달 */
.success-modal {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 320px;
  height: 320px;
  display: flex;
  justify-content: center;
  align-items: center;
  transform: translate(-50%, -50%) scale(0);
  opacity: 0;
  z-index: 20;
  transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.5s ease;
}

.success-modal.show {
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
}

.success-modal img {
  width: 100%;   /* 모달 전체를 이미지로 채움 */
  height: 100%;
  object-fit: cover;
  border-radius: 0; /* 원형 이미지 제거 */
}

/* 텍스트 요소 */
.status {
  color: #3182f6;
  font-weight: 600;
  margin-top: 30px;
  font-size: 18px;
}

#counter {
  margin-top: 10px;
  color: #8b95a1;
  font-size: 15px;
}

.result {
  font-size: 22px;
  font-weight: bold;
  margin-top: 20px;
  color: #333d4b;
  line-height: 1.5;
}

.progress-wrap {
  display: none;
}
</style>
</head>

<body>

<h1>얼굴 로그인</h1>

<div class="container">
  <div class="loading-overlay" id="loadingSpinner">
    <div class="google-spinner">
      <div></div><div></div><div></div><div></div>
    </div>
  </div>

  <svg class="progress-ring">
    <circle class="progress-ring__circle-bg" cx="160" cy="160" r="150"/>
    <circle class="progress-ring__circle" id="ringCircle" cx="160" cy="160" r="150"/>
  </svg>

  <video id="video" autoplay muted playsinline></video>
  
  <div class="success-modal" id="successModal">
    <img src="https://cdn-icons-png.flaticon.com/256/10337/10337354.png" alt="success">
  </div>
</div>

<div class="status" id="status"></div>
<div class="progress-wrap">
  <div class="progress" id="progress"></div>
</div>
<div id="counter">0 / 10 수집</div>
<div class="result" id="result"></div>

<script>
const video = document.getElementById("video");
const counter = document.getElementById("counter");
const progress = document.getElementById("progress");
const resultBox = document.getElementById("result");

const ringCircle = document.getElementById("ringCircle");
const radius = ringCircle.r.baseVal.value;
const circumference = radius * 2 * Math.PI;
const loadingSpinner = document.getElementById("loadingSpinner");
const successModal = document.getElementById("successModal");
const spinnerDivs = document.querySelectorAll('.google-spinner div');

ringCircle.style.strokeDasharray = `${circumference} ${circumference}`;
ringCircle.style.strokeDashoffset = circumference;

function setProgressRing(percent) {
  const offset = circumference - (percent / 100) * circumference;
  ringCircle.style.strokeDashoffset = offset;
}

const REQUIRED = 10;
let collected = [];
let detecting = true;
let interval;

async function loadModels() {
  await Promise.all([
    faceapi.nets.ssdMobilenetv1.loadFromUri("./models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("./models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("./models")
  ]);
  startCamera();
}

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;

  video.onloadedmetadata = () => {
      video.play();
      loadingSpinner.style.display = 'none';
  };

  startDetectLoop();
}

function startDetectLoop() {
  detecting = true;
  collected = [];
  counter.innerText = `0 / ${REQUIRED} 수집`;
  setProgressRing(0);
  ringCircle.style.stroke = '#3182f6';
  spinnerDivs.forEach(d => d.style.borderColor = '#3182f6 transparent transparent transparent');

  interval = setInterval(async () => {
    if (!detecting || collected.length >= REQUIRED) return;

    const detection = await faceapi
      .detectSingleFace(video)
      .withFaceLandmarks()
      .withFaceDescriptor();

    if (!detection) return;

    collected.push(detection.descriptor);

    counter.innerText = `${collected.length} / ${REQUIRED} 수집`;
    setProgressRing((collected.length / REQUIRED) * 100);

    if (collected.length >= REQUIRED) {
      clearInterval(interval);
      detecting = false;
      loadingSpinner.style.display = 'flex';
      sendLogin();
    }
  }, 800);
}

function averageVectors(vectors) {
  const avg = new Array(vectors[0].length).fill(0);
  vectors.forEach(v => {
    v.forEach((val, i) => avg[i] += val);
  });
  return avg.map(v => v / vectors.length);
}

async function sendLogin() {
  const avgVector = averageVectors(collected);

  const res = await fetch("https://jaewondev2.pythonanywhere.com/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ vector: avgVector })
  });

  const data = await res.json();
  loadingSpinner.style.display = 'none';

  if (data.success && data.distance <= 0.25) {
    const percent = Math.max(0, Math.round((1 - data.distance) * 100));
    resultBox.innerHTML = `✅ 로그인 성공<br>${data.name}<br>${percent}% 일치`;

    successModal.classList.add('show');

    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
    }

  } else {
    const percent = Math.max(0, Math.round((1 - data.distance) * 100));
    resultBox.innerHTML = `❌ 실패<br>${percent}% 일치<br>인증 실패 - 얼굴 불일치`;

    ringCircle.style.stroke = '#b50000';
    spinnerDivs.forEach(d => d.style.borderColor = '#b50000 transparent transparent transparent');

    setTimeout(() => {
      startDetectLoop();
    }, 2000);
  }
}

loadModels();
</script>

</body>
</html>
