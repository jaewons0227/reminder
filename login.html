<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì–¼êµ´ ë¡œê·¸ì¸</title>

<script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
body {
  font-family: Arial;
  text-align: center;
  margin-top: 30px;
}
video {
  border: 2px solid black;
}
</style>
</head>

<body>

<h2>ì–¼êµ´ ë¡œê·¸ì¸</h2>

<video id="video" width="360" height="270" autoplay muted playsinline></video>
<br>

<button id="loginBtn" disabled>ë¡œê·¸ì¸</button>

<p id="result"></p>

<script>
const video = document.getElementById("video");
const result = document.getElementById("result");
const btn = document.getElementById("loginBtn");

let ready = false;

async function loadModels() {
  await Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri("./models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("./models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("./models")
  ]);

  result.innerText = "âœ… ëª¨ë¸ ë¡œë“œ ì™„ë£Œ";
  btn.disabled = false;
}

loadModels();

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: "user",
      width: { ideal: 640 },
      height: { ideal: 480 }
    }
  });

  video.srcObject = stream;

  video.onloadedmetadata = () => {
    ready = true;
  };
}

startCamera();

btn.onclick = async () => {
  if (!ready) {
    result.innerText = "ğŸ“· ì¹´ë©”ë¼ ì¤€ë¹„ì¤‘...";
    return;
  }

  result.innerText = "ì¸ì‹ ì¤‘...";

  const detection = await faceapi
    .detectSingleFace(
      video,
      new faceapi.TinyFaceDetectorOptions({
        inputSize: 512,
        scoreThreshold: 0.4
      })
    )
    .withFaceLandmarks()
    .withFaceDescriptor();

  console.log("DETECTION:", detection);

  if (!detection) {
    result.innerText = "âŒ ì–¼êµ´ì´ ì¸ì‹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤";
    return;
  }

  const res = await fetch("https://jaewondev2.pythonanywhere.com/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      vector: Array.from(detection.descriptor)
    })
  });

  const data = await res.json();

  if (data.success) {
    result.innerText = `âœ… ${data.name} ë¡œê·¸ì¸ ì„±ê³µ`;
  } else {
    result.innerText = `âŒ ë§¤ì¹­ ì‹¤íŒ¨ (ê±°ë¦¬: ${data.distance.toFixed(3)})`;
  }
};
</script>

</body>
</html>
