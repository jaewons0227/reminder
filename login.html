<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì–¼êµ´ ë¡œê·¸ì¸</title>

<script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
/* Toss ìŠ¤íƒ€ì¼ ëª¨ë˜ í™”ì´íŠ¸ í…Œë§ˆ */
body {
  margin: 0;
  background-color: #ffffff; /* í™”ì´íŠ¸ ë°°ê²½ */
  color: #191f28; /* Toss í…ìŠ¤íŠ¸ ì»¬ëŸ¬ (ë‹¤í¬ ê·¸ë ˆì´) */
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}

h1 {
  margin-top: 60px;
  font-size: 26px;
  font-weight: 700;
  color: #333d4b;
}

.container {
  margin-top: 40px;
  position: relative;
  width: 320px;
  height: 320px;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ì›í˜• ë¹„ë””ì˜¤ */
video {
  width: 280px;
  height: 280px;
  border-radius: 50%; /* ì›í˜• */
  object-fit: cover; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ìš°ê¸° */
  /* border: 3px solid #38bdf8; -> ê¸°ì¡´ í…Œë‘ë¦¬ ì œê±° í›„ SVGë¡œ ëŒ€ì²´ */
  background-color: #f2f4f6; /* ë¹„ë””ì˜¤ ë¡œë”© ì „ ë°°ê²½ìƒ‰ */
  transform: scaleX(-1); /* ê±°ìš¸ëª¨ë“œ */
  position: absolute;
  z-index: 1;
}

/* ì›í˜• í”„ë¡œê·¸ë ˆìŠ¤ ë°” (SVG) */
.progress-ring {
  position: absolute;
  top: 0;
  left: 0;
  width: 320px;
  height: 320px;
  transform: rotate(-90deg); /* 12ì‹œ ë°©í–¥ë¶€í„° ì‹œì‘ */
  z-index: 2;
  pointer-events: none;
}

.progress-ring__circle-bg {
  stroke: #e5e8eb; /* íšŒìƒ‰ íŠ¸ë™ */
  stroke-width: 8;
  fill: transparent;
}

.progress-ring__circle {
  stroke: #3182f6; /* Toss Blue */
  stroke-width: 8;
  fill: transparent;
  stroke-linecap: round; /* í…Œë‘ë¦¬ ë‘¥ê¸€ê²Œ */
  /* ì›ì£¼ìœ¨ ê³„ì‚° (r=150ì¼ ë•Œ): 2 * pi * 150 â‰ˆ 942 */
  stroke-dasharray: 942;
  stroke-dashoffset: 942; /* ì´ˆê¸°ì—ëŠ” ê½‰ ì°¨ìˆì§€ ì•ŠìŒ */
  transition: stroke-dashoffset 0.5s ease-in-out;
}

/* ë¡œë”© ìŠ¤í”¼ë„ˆ (ìš”ì²­í•˜ì‹  ìŠ¤íƒ€ì¼) */
.loading-overlay {
  position: absolute;
  z-index: 10;
  background: rgba(255, 255, 255, 0.8);
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 50%;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 5px solid #e5e8eb; /* ì—°í•œ íšŒìƒ‰ ë°”íƒ• */
  border-top: 5px solid #3182f6; /* íŒŒë€ìƒ‰ í¬ì¸íŠ¸ */
  border-radius: 50%; /* ë‘¥ê·¼ ëª¨ì–‘ */
  animation: spin 1s linear infinite;
  box-sizing: border-box;
  /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ ì²˜ë¦¬ (Chrome ë“±ì—ì„œ border-topë§Œ ìƒ‰ìƒ ìˆì„ ë•Œ íš¨ê³¼ì ) */
  stroke-linecap: round; 
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* í…ìŠ¤íŠ¸ ìš”ì†Œë“¤ */
.status {
  color: #3182f6; /* Toss Blue */
  font-weight: 600;
  margin-top: 30px;
  font-size: 18px;
}

#counter {
  margin-top: 10px;
  color: #8b95a1; /* ì—°í•œ íšŒìƒ‰ */
  font-size: 15px;
}

.result {
  font-size: 22px;
  font-weight: bold;
  margin-top: 20px;
  color: #333d4b;
  line-height: 1.5;
}

/* ê¸°ì¡´ ì§ì„ í˜• ë°” ìˆ¨ê¹€ (ì‚­ì œí•˜ì§€ ì•Šê³  ìˆ¨ê¹€ ì²˜ë¦¬) */
.progress-wrap {
  display: none; 
}
</style>
</head>

<body>

<h1>ì–¼êµ´ ë¡œê·¸ì¸</h1>

<div class="container">
  <div class="loading-overlay" id="loadingSpinner">
    <div class="spinner"></div>
  </div>

  <svg class="progress-ring">
    <circle class="progress-ring__circle-bg" cx="160" cy="160" r="150"/>
    <circle class="progress-ring__circle" id="ringCircle" cx="160" cy="160" r="150"/>
  </svg>

  <video id="video" autoplay muted playsinline></video>
</div>

<div class="status" id="status">ëª¨ë¸ ë¡œë”©ì¤‘...</div>

<div class="progress-wrap">
  <div class="progress" id="progress"></div>
</div>

<div id="counter">0 / 10 ìˆ˜ì§‘</div>

<div class="result" id="result"></div>

<script>
const video = document.getElementById("video");
const statusText = document.getElementById("status");
const counter = document.getElementById("counter");
const progress = document.getElementById("progress");
const resultBox = document.getElementById("result");

// ì›í˜• í”„ë¡œê·¸ë ˆìŠ¤ ì œì–´ë¥¼ ìœ„í•œ ë³€ìˆ˜
const ringCircle = document.getElementById("ringCircle");
const radius = ringCircle.r.baseVal.value;
const circumference = radius * 2 * Math.PI;
const loadingSpinner = document.getElementById("loadingSpinner");

// ì´ˆê¸° ì„¤ì •: ì› ë‘˜ë ˆë§Œí¼ ìˆ¨ê¹€
ringCircle.style.strokeDasharray = `${circumference} ${circumference}`;
ringCircle.style.strokeDashoffset = circumference;

function setProgressRing(percent) {
  const offset = circumference - (percent / 100) * circumference;
  ringCircle.style.strokeDashoffset = offset;
}

const REQUIRED = 10;
let collected = [];
let detecting = true;

// -------------------------

async function loadModels() {
  await Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri("./models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("./models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("./models")
  ]);

  statusText.innerText = "ì¹´ë©”ë¼ ì‹œì‘ì¤‘...";
  startCamera();
}

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;

  // ë¹„ë””ì˜¤ê°€ ì‹¤ì œë¡œ ì¬ìƒë  ë•Œ ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
  video.onloadedmetadata = () => {
      video.play();
      loadingSpinner.style.display = 'none'; // ë¡œë”© ì™„ë£Œ í›„ ìŠ¤í”¼ë„ˆ ì œê±°
  };

  statusText.innerText = "ì •ë©´ì„ ë´ì£¼ì„¸ìš”";
  startDetectLoop();
}

// -------------------------

async function startDetectLoop() {

  const interval = setInterval(async () => {

    if (!detecting || collected.length >= REQUIRED) return;

    const detection = await faceapi
      .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({
        inputSize: 224,
        scoreThreshold: 0.4   // ğŸ”¥ ë‚®ì¶°ì„œ ì¸ì‹ ì˜ ë˜ê²Œ
      }))
      .withFaceLandmarks()
      .withFaceDescriptor();

    if (!detection) return;

    collected.push(detection.descriptor);

    counter.innerText = `${collected.length} / ${REQUIRED} ìˆ˜ì§‘`;
    
    // ê¸°ì¡´ ì½”ë“œ ìœ ì§€
    progress.style.width = `${(collected.length / REQUIRED) * 100}%`;
    
    // [ì¶”ê°€] ì›í˜• í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
    setProgressRing((collected.length / REQUIRED) * 100);

    if (collected.length >= REQUIRED) {
      clearInterval(interval);
      detecting = false;
      statusText.innerText = "ë¶„ì„ì¤‘...";
      // ìŠ¤í”¼ë„ˆ ë‹¤ì‹œ í‘œì‹œ (ë¶„ì„ ì¤‘ ëŠë‚Œ)
      loadingSpinner.style.display = 'flex';
      sendLogin();
    }

  }, 800);
}

// -------------------------

function averageVectors(vectors) {

  const avg = new Array(vectors[0].length).fill(0);

  vectors.forEach(v => {
    v.forEach((val, i) => avg[i] += val);
  });

  return avg.map(v => v / vectors.length);
}

// -------------------------

async function sendLogin() {

  const avgVector = averageVectors(collected);

  const res = await fetch("https://jaewondev2.pythonanywhere.com/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      vector: avgVector
    })
  });

  const data = await res.json();
  
  // ê²°ê³¼ ë‚˜ì˜¤ë©´ ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
  loadingSpinner.style.display = 'none';

  if (data.success) {

    const percent = Math.max(0, Math.round((1 - data.distance) * 100));

    resultBox.innerHTML =
      `âœ… ë¡œê·¸ì¸ ì„±ê³µ<br>${data.name}<br>${percent}% ì¼ì¹˜`;

  } else {

    const percent = Math.max(0, Math.round((1 - data.distance) * 100));

    resultBox.innerHTML =
      `âŒ ì‹¤íŒ¨<br>${percent}% ì¼ì¹˜`;

  }

}
loadModels();
</script>

</body>
</html>
